<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>START 페이지</title>

    <script src="https://cdn.jsdelivr.net/npm/mathjs@12.4.2/lib/browser/math.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="index.css">
  </head>
  <body>

    <header class="bg-blue-500 text-white p-6 text-center">
      <h1 class="text-4xl font-bold">환영합니다! 계산기</h1>
    </header>

    <main class="container mx-auto mt-8 p-4">

      <!-- <div class="bg-gray-100 p-6 rounded-lg shadow-md">
        <h2 class="text-2xl font-semibold mb-4">소개</h2>
        <p class="text-gray-700">계산기 페이지 입니다.</p>
      </div> -->

      <div class="space-y-4 p-4 max-w-lg mx-auto">
        <!-- <div class="border border-blue-300"> -->
        <div>
          <label for="calculator-input" class="block text-sm font-medium text-gray-700 mb-1">계산식</label>
          <input
            type="text"
            id="calculator-input"
            name="calculator-input"
            placeholder="예: 10 * 5 + 2"
            readonly
            class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200"
          >
        </div>
      
        <div>
          <label for="result-output" class="block text-sm font-medium text-gray-700 mb-1">결과</label>
          <textarea
            id="result-output"
            name="result-output"
            rows="4"
            readonly
            class="w-full p-2 border border-gray-300 rounded-md shadow-sm bg-gray-100 text-gray-600 cursor-not-allowed"
          ></textarea>
        </div>
      </div>

      <div class="space-y-4 p-4 max-w-lg mx-auto">
  
        <div class="flex gap-2 mt-4">
          <div class="flex-grow grid grid-cols-3 gap-2">
            <!-- <button class="special-button" data-value="17">17</button> -->
            <button data-value="7" class="p-4 bg-white hover:bg-gray-100 rounded-md shadow-sm font-bold text-lg text-gray-900">7</button>
            <button data-value="8" class="p-4 bg-white hover:bg-gray-100 rounded-md shadow-sm font-bold text-lg text-gray-900">8</button>
            <button data-value="9" class="p-4 bg-white hover:bg-gray-100 rounded-md shadow-sm font-bold text-lg text-gray-900">9</button>

            <button data-value="4" class="p-4 bg-white hover:bg-gray-100 rounded-md shadow-sm font-bold text-lg text-gray-900">4</button>
            <button data-value="5" class="p-4 bg-white hover:bg-gray-100 rounded-md shadow-sm font-bold text-lg text-gray-900">5</button>
            <button data-value="6" class="p-4 bg-white hover:bg-gray-100 rounded-md shadow-sm font-bold text-lg text-gray-900">6</button>

            <button data-value="1" class="p-4 bg-white hover:bg-gray-100 rounded-md shadow-sm font-bold text-lg text-gray-900">1</button>
            <button data-value="2" class="p-4 bg-white hover:bg-gray-100 rounded-md shadow-sm font-bold text-lg text-gray-900">2</button>
            <button data-value="3" class="p-4 bg-white hover:bg-gray-100 rounded-md shadow-sm font-bold text-lg text-gray-900">3</button>
            
            <button data-value="." class="p-4 bg-white hover:bg-gray-100 rounded-md shadow-sm font-bold text-lg text-gray-900">.</button>
            <button data-value="0" class="p-4 bg-white hover:bg-gray-100 rounded-md shadow-sm font-bold text-lg text-gray-900">0</button>
            <button data-value="00" class="p-4 bg-white hover:bg-gray-100 rounded-md shadow-sm font-bold text-lg text-gray-900">00</button>
            <button data-value="000" class="p-4 bg-white hover:bg-gray-100 rounded-md shadow-sm font-bold text-lg text-gray-900">000</button>
          </div>
    
          <div class="flex-grow grid grid-cols-2 gap-2">
            <button data-value="(" class="p-4 bg-orange-500 hover:bg-orange-600 rounded-md shadow-sm font-bold text-xl text-white">(</button>
            <button data-value=")" class="p-4 bg-orange-500 hover:bg-orange-600 rounded-md shadow-sm font-bold text-xl text-white">)</button>
            <button data-value="%" class="p-4 bg-orange-500 hover:bg-orange-600 rounded-md shadow-sm font-bold text-xl text-white">%</button>
            <button data-value="÷" class="p-4 bg-orange-500 hover:bg-orange-600 rounded-md shadow-sm font-bold text-xl text-white">÷</button>
            <button data-value="×" class="p-4 bg-orange-500 hover:bg-orange-600 rounded-md shadow-sm font-bold text-xl text-white">×</button>
            <button data-value="-" class="p-4 bg-orange-500 hover:bg-orange-600 rounded-md shadow-sm font-bold text-xl text-white">-</button>
            <button data-value="+" class="p-4 bg-orange-500 hover:bg-orange-600 rounded-md shadow-sm font-bold text-xl text-white">+</button>
            <button id="enter" data-value="=" class="p-4 bg-blue-500 hover:bg-blue-600 rounded-md shadow-sm font-bold text-2xl text-white">=</button>
          </div>
        </div>
      </div>

      <div class="space-y-2 p-4 max-w-lg mx-auto bg-gray-50 rounded-lg shadow-xl">

        <div class="grid grid-cols-5 gap-2">
          <button data-value="BS" class="p-2 bg-red-500 hover:bg-red-600 rounded-md shadow-sm font-bold text-sm text-white"><</button>
          <button data-value="AC" class="p-2 bg-red-500 hover:bg-red-600 rounded-md shadow-sm font-bold text-sm text-white">AC</button>
          <button data-value="CE" class="p-2 bg-red-500 hover:bg-red-600 rounded-md shadow-sm font-bold text-sm text-white hidden">CE</button>
          <button data-value="C" class="p-2 bg-red-500 hover:bg-red-600 rounded-md shadow-sm font-bold text-sm text-white">C</button>
          <button data-value="+/-" class="p-2 bg-gray-200 hover:bg-gray-300 rounded-md shadow-sm font-bold text-sm text-gray-800 hidden">+/-</button>
          <button data-value="GT" class="p-2 bg-gray-200 hover:bg-gray-300 rounded-md shadow-sm font-bold text-sm text-gray-800 hidden">GT</button>
        </div>
        
        <div class="grid grid-cols-4 gap-2">
          <button data-value="MC" class="p-2 bg-gray-200 hover:bg-gray-300 rounded-md shadow-sm font-bold text-sm text-gray-800 hidden">MC</button>
          <button data-value="MR" class="p-2 bg-gray-200 hover:bg-gray-300 rounded-md shadow-sm font-bold text-sm text-gray-800 hidden">MR</button>
          <button data-value="M+" class="p-2 bg-green-500 hover:bg-green-600 rounded-md shadow-sm font-bold text-sm text-white hidden">M+</button>
          <button data-value="M-" class="p-2 bg-green-500 hover:bg-green-600 rounded-md shadow-sm font-bold text-sm text-white hidden">M-</button>
        </div>
      </div>
    </main>

    <footer class="bg-gray-800 text-white p-4 mt-8 text-center">
      <p>&copy; 2025 START 페이지</p>
    </footer>

    <audio id="soundEffect" src="https://cdn-assets-eu.frontify.com/s3/frontify-enterprise-files-eu/eyJwYXRoIjoic3VwZXJjZWxsXC9maWxlXC9tOHhmREpvcnVYUUNURm5kUlZVai5vZ2cifQ:supercell:gLfxd34G1ZpUaPNbikkcLPEeTF_XP8z78kDY7e3_DYU?width={width}&format=mp3"></audio>

    <script>
      const calculatorInput = document.getElementById('calculator-input');
      const resultOutput = document.getElementById('result-output');
      const buttons = document.querySelectorAll('button[data-value]');
      const enterButton = document.getElementById('enter');

      const soundEffect = document.getElementById('soundEffect');
      const scope = {};

      // const allowedKeysRegex = /[0-9+\-*/.]/;
      // const allowedKeysRegex = /[0-9+\-*/.()pisqrtco]/;
      const allowedKeysRegex = /^[0-9=+\-*/.()a-z^\[\]\s]*$/;

      function calculateExpression() {
        const expression = calculatorInput.value;
        const sanitizedExpression = expression
          .replace(/÷/g, '/')  // ÷를 /로 변환
          .replace(/×/g, '*'); // ×도 *로 변환 (사용자가 입력할 수 있으므로 함께 처리하는 것이 좋습니다)
        const assignmentMatch = expression.match(/^([a-z]+)\s*=\s*(.*)$/);

        try {
          // if (assignmentMatch) {
          //   // 2. 변수 할당 구문일 경우
          //   const variableName = assignmentMatch[1]; // 'x'
          //   const variableValue = math.evaluate(assignmentMatch[2], scope); // 3
            
          //   // 스코프 객체에 변수와 값을 저장합니다.
          //   scope[variableName] = variableValue;
          //   console.log(`변수 "${variableName}"와 값 "${variableValue}"를 스코프 객체에 저장하여 구성된 계산식: ${scope.stringify()}`);
          //   resultOutput.value = `계산식: ${scope}\n결과: ${result}`;
          //   return `${variableName} = ${variableValue}`;
          // } 
          

          const result = math.evaluate(sanitizedExpression);
          resultOutput.value = `계산식: ${expression}\n결과: ${result}`;
          calculatorInput.value = '';

          // if (soundEffect) {
          //     soundEffect.currentTime = 0;
          //     soundEffect.play();
          // }          

        } catch (error) {
          resultOutput.value = `오류: 잘못된 계산식입니다.`;
          console.error(error);
        }


      }

      function checkExpression() {
        return 
        console.log("checkExpression called");
        const expression = calculatorInput.value;
        const sanitizedExpression = expression
          .replace(/÷/g, '/')  // ÷를 /로 변환
          .replace(/×/g, '*'); // ×도 *로 변환 (사용자가 입력할 수 있으므로 함께 처리하는 것이 좋습니다)

        try {
          // 전역 객체 math를 사용하여 수식 계산
          const result = math.evaluate(sanitizedExpression);

        } catch (error) {
          const errorIndex = error.index;
          let errorMessage = '오류: 잘못된 계산식입니다.';

          if (errorIndex !== undefined) {
            // 오류 위치를 시각적으로 표시하는 문자열 생성
            const errorIndicator = ' '.repeat(errorIndex) + '^';
            errorMessage = `오류: 잘못된 계산식입니다.\n\n${expression}\n${errorIndicator}\n오류 위치를 확인하세요.`;
          }
          
          resultOutput.value = errorMessage;
          console.error(error);
        }
      }

      function evaluateAndHandleError(expression) {
        // 1. 입력된 수식의 마지막 문자가 연산자인지 확인합니다.
        const lastChar = expression.trim().slice(-1);
        const isOperator = ['+', '-', '*', '/'].includes(lastChar);
        
        // 2. 수식이 비어있거나 마지막 문자가 연산자일 경우,
        //    아직 수식이 완성되지 않았다고 판단하여 계산하지 않습니다.
        if (expression.trim() === '' || isOperator) {
          return null; // 또는 '수식을 완성하세요'와 같은 메시지를 반환
        }

        try {
          // 3. 수식이 완성되었다고 판단되면 계산을 시도합니다.
          const result = math.evaluate(expression);
          return result;
        } catch (error) {
          // 4. 계산 중 발생하는 명백한 문법 오류를 처리합니다.
          console.error('잘못된 계산식:', error);
          
          // math.js 오류 객체의 index를 사용해 오류 위치를 표시할 수도 있습니다.
          const errorIndex = error.index;
          if (errorIndex !== undefined) {
            const errorIndicator = ' '.repeat(errorIndex) + '^';
            return `오류: 잘못된 계산식입니다.\n\n${expression}\n${errorIndicator}\n`;
          }
          
          return '오류: 잘못된 계산식입니다.';
        }
      }

      function sendEnterKeyEvent() {
            // calculateExpression(value);
            const enterKeyEvent = new KeyboardEvent('keydown', {
              key: 'Enter',
              code: 'Enter',
              bubbles: true,   // 이벤트가 DOM 트리를 따라 버블링되도록 설정
              cancelable: true // 이벤트가 취소될 수 있도록 설정
            });

            // 생성된 이벤트를 calculatorInput에 전달합니다.
            document.dispatchEvent(enterKeyEvent);
      }
    
      function enterClicked() {
        enterButton.click();
      }

      buttons.forEach(button => {
        button.addEventListener('click', () => {
          const value = button.dataset.value;
          
          if (value === 'AC') {
            // AC 버튼: 입력 필드와 결과 필드 모두 초기화
            calculatorInput.value = '';
            resultOutput.value = '';
            checkExpression();
          } else if (value === 'C') {
            // C 버튼: 입력 필드만 초기화
            calculatorInput.value = '';
            checkExpression();
          } else if (value === 'BS') {
            // C 버튼: 입력 필드만 초기화
            calculatorInput.value = calculatorInput.value.slice(0, -1);
            checkExpression();
          } else if (value === '=') {
            // sendEnterKeyEvent();
            calculateExpression();
          } else {
            calculatorInput.value += value;
            checkExpression();
          }
        });
      });
    
      // // 엔터 키 입력 시 계산 실행 (기존 코드 유지)
      // calculatorInput.addEventListener('keydown', function(event) {
      //   if (event.key === 'Enter') {
      //     event.preventDefault();
      //     try {
      //       calculateExpression(value);
      //     } catch (error) {
      //       resultOutput.value = `오류: 잘못된 계산식입니다.`;
      //     }
      //   }
      // });

      // calculatorInput.addEventListener('input', checkExpression);
      // calculatorInput.addEventListener('change', checkExpression);
      document.addEventListener('paste', (event) => {
        // 1. 붙여넣기 이벤트의 기본 동작을 막습니다.
        // 이렇게 해야 브라우저가 입력 필드에 직접 붙여넣지 않습니다.
        event.preventDefault();
        
        // 2. 클립보드에 있는 텍스트 데이터를 가져옵니다.
        const pasteText = event.clipboardData.getData('text/plain');
        
        if (allowedKeysRegex.test(pasteText)) {
          // 4. 유효성 검사를 통과하면 calculatorInput에 값을 추가합니다.
          calculatorInput.value += pasteText;
        } else {
          // 유효하지 않은 문자가 포함된 경우
          console.log('잘못된 형식의 텍스트입니다. 붙여넣기가 차단되었습니다.');
        }
      });


      document.addEventListener('keydown', (event) => {
        // const output = document.getElementById('output');
        const keyName = event.key;
        const keyCode = event.code;
        console.log(`keyName: ${keyName}, keyCode: ${keyCode}`);

        if (keyName === 'Enter') {
          
          // sendEnterKeyEvent();
          enterClicked()
          event.preventDefault();
          return;
        }
        else if (keyName === 'Backspace') {
          // 'Backspace' 키를 누르면 마지막 글자 제거
          calculatorInput.value = calculatorInput.value.slice(0, -1);
          // checkExpression();
          event.preventDefault();
          return;
        } else if (keyName === 'Escape') {
          calculatorInput.value = '';
          event.preventDefault();
          return
        }

        if (event.shiftKey) {
          if (keyName !== 'Shift') {
            calculatorInput.value += keyName;
          }
          event.preventDefault();
          return;
        }

        if (event.metaKey) {
          return;
        }

        if (event.ctrlKey) {
          return;
        }

        if (event.altKey) {
          return;
        }

        const disabledKeys = [
          'CapsLock', 
          'NumLock', 
          'Pause', 
          'ScrollLock',
          'Insert',
          'Home',
          'End',
          'PageUp',
          'PageDown',
          'Delete',
          'Tab',
          'ArrowLeft',
          'ArrowRight',
          'ArrowUp',
          'ArrowDown'

        ];
        if (disabledKeys.includes(keyName)) {
          // 키의 기본 동작을 막습니다.
          event.preventDefault();
          console.log(`${keyName} 키의 기본 동작이 차단되었습니다.`);
          return;
        }

        if (keyName.startsWith('F') && keyName.length > 1 && !isNaN(keyName.slice(1))) {
          // F2 키가 눌렸을 때 특정 함수 실행
          return;
          // if (keyName === 'F2') {
          //   console.log('F2 키가 눌렸습니다. 파일을 저장합니다.');
          //   // 여기에 F2 키에 대한 특정 로직을 추가하세요.
          //   // saveFile();
          // }
        }

        console.log(`키가 눌렸습니다: "${keyName}" (코드: ${keyCode})`);

        const newkeyName = keyName.toLowerCase();
        if (allowedKeysRegex.test(newkeyName)) {
          // 허용된 키(숫자, 연산자, 소수점)만 입력
          calculatorInput.value += newkeyName;
          // checkExpression();
        }
      });

      // const redButtonClasses = "p-2 bg-red-500 hover:bg-red-600 rounded-md shadow-sm font-bold text-sm text-white";
      // const specialButtons = document.querySelectorAll('.special-button');
      // specialButtons.forEach(button => {
      //   button.className = redButtonClasses;
      // });


    </script>

  </body>
</html>
